# Onboarding Flow Redesign - Requirements

## Feature Overview

Redesign the onboarding flow from a 9-step preference collection system to a 4-step value-first system where users see and approve their complete workout and meal plans during onboarding.

**Feature Name:** onboarding-flow-redesign  
**Priority:** High  
**Status:** Requirements Approved  
**Target Release:** v2.0

---

## Database Schema Analysis

### Current Schema Assessment

After analyzing the existing database schema, we found that **most tables already exist** and support the new onboarding flow with minimal changes:

#### ‚úÖ Tables That Need NO Changes:
1. **workout_plans** - Already has `plan_data` JSONB field perfect for storing complete workout structures
2. **meal_plans** - Already stores macros in grams (not percentages)
3. **fitness_goals** - Supports multiple goals with priorities
4. **physical_constraints** - Supports equipment, injuries, limitations
5. **dietary_preferences** - Supports diet type, allergies, intolerances, dislikes
6. **meal_schedules** - Supports meal timing with notifications
7. **workout_schedules** - Supports workout timing with notifications
8. **hydration_preferences** - Supports water targets and reminders
9. **user_profiles** - Central profile entity with all relationships

#### üîß Tables That Need Minor Changes:
1. **meal_templates** - Add columns: plan_name, daily_calorie_target, protein_grams, carbs_grams, fats_grams, weekly_template (JSONB)
2. **onboarding_states** - Add step completion flags (step_1_complete through step_4_complete), modify current_step default to 1

#### ‚ùå Tables We DON'T Need to Create:
- ~~workout_plans~~ - Already exists!
- ~~meal_plan_templates~~ - meal_templates already exists, just needs new columns

### Key Insights:

1. **WorkoutPlan.plan_data** - The existing JSONB field is perfect for storing the complete workout plan structure generated by agents. We don't need to create a new table.

2. **Foreign Key Difference** - workout_plans references `users.id` (not `user_profiles.id`), which is fine since we can get the profile through the user relationship.

3. **Meal Plans** - The existing meal_plans table already stores macros in grams (not percentages), which is exactly what we need.

4. **Backward Compatibility** - meal_templates has relationships to TemplateMeal which we'll keep for backward compatibility, but new onboarding will primarily use the weekly_template JSONB field.

### Migration Strategy Simplified:

Instead of creating new tables, we only need to:
1. Add columns to meal_templates
2. Add step completion flags to onboarding_states
3. Clear existing onboarding_states data (no backward compatibility needed)

This significantly reduces implementation complexity!

---

## Problem Statement

The current 9-step onboarding system has several issues:
- Users answer questions without seeing tangible results
- Long perceived time (9 steps feels overwhelming)
- Abstract data collection without immediate value
- Trust gap - users don't know what they're getting until completion
- Lower completion rates (~60%)

---

## Goals & Success Criteria

### Primary Goals
1. Increase onboarding completion rate from 60% to >85%
2. Reduce average onboarding time from 35+ minutes to <25 minutes
3. Deliver immediate value by showing actual plans during onboarding
4. Build trust through transparent plan generation and approval

### Success Metrics
- Onboarding completion rate: >85%
- Average time to complete: <25 minutes
- User satisfaction rating: >4.5/5
- Plan approval rate: >90% within 2 iterations
- Week 1 engagement: >70% of users log activity

---

## User Stories

### Epic 1: Fitness Assessment (Step 1)

#### Story 1.1: Collect Fitness Level
**As a** new user  
**I want to** tell the agent my fitness experience level  
**So that** my workout plan matches my capabilities

**Acceptance Criteria:**
- User can chat naturally with Fitness Assessment Agent
- Agent asks about fitness level (beginner/intermediate/advanced)
- Agent asks about years of training experience
- Agent validates and saves fitness level via tool call
- System stores: fitness_level, experience_years

#### Story 1.2: Collect Fitness Goals
**As a** new user  
**I want to** specify my fitness goals  
**So that** my plans align with what I want to achieve

**Acceptance Criteria:**
- Agent asks about primary goal (fat_loss/muscle_gain/general_fitness)
- Agent asks about secondary goal (optional)
- Agent asks about goal priority
- Agent validates and saves goals via tool call
- System stores: primary_goal, secondary_goal, goal_priority
- Agent confirms understanding and transitions to Step 2

---

### Epic 2: Workout Planning (Step 2)

#### Story 2.1: Collect Workout Constraints
**As a** new user  
**I want to** tell the agent about my equipment and limitations  
**So that** my workout plan is realistic and safe

**Acceptance Criteria:**
- User chats with Workout Planning Agent
- Agent asks about workout location (gym/home/minimal)
- Agent asks about available equipment
- Agent asks about injuries or physical limitations
- Agent asks about time availability (days/week, minutes/session)
- Agent validates and saves constraints via tool call
- System stores: equipment, injuries, limitations, days_per_week, minutes_per_session

#### Story 2.2: Generate Complete Workout Plan
**As a** new user  
**I want to** see a complete workout plan generated for me  
**So that** I know exactly what I'll be doing

**Acceptance Criteria:**
- Agent uses LLM to generate complete workout plan based on:
  - Fitness level (from Step 1)
  - Goals (from Step 1)
  - Equipment and constraints (from Story 2.1)
- Generated plan includes:
  - Weekly split structure
  - Specific exercises for each day
  - Sets, reps, rest periods
  - Progressive overload strategy
  - Cardio/HIIT integration
  - Rest days
  - Duration (weeks)
- Plan is displayed in readable format
- Plan respects all constraints (injuries, equipment)

#### Story 2.3: Review and Refine Workout Plan
**As a** new user  
**I want to** review and request changes to my workout plan  
**So that** I'm comfortable with what I'll be doing

**Acceptance Criteria:**
- User can read the complete generated plan
- User can request modifications ("Can we swap X for Y?")
- Agent understands modification requests
- Agent regenerates plan with requested changes
- User can iterate until satisfied
- User explicitly approves the plan ("This looks perfect!")

#### Story 2.4: Save Approved Workout Plan
**As a** new user  
**I want to** have my approved workout plan saved  
**So that** I can access it after onboarding

**Acceptance Criteria:**
- Agent saves complete workout plan via tool call
- System creates WorkoutPlan entity with full plan_data JSONB
- System links plan to user's profile
- Agent confirms save and transitions to Step 3
- System marks step_2_complete = true

---

### Epic 3: Meal Planning (Step 3)

#### Story 3.1: Collect Diet Preferences
**As a** new user  
**I want to** tell the agent about my dietary preferences and restrictions  
**So that** my meal plan fits my lifestyle

**Acceptance Criteria:**
- User chats with Diet Planning Agent
- Agent asks about diet type (omnivore/vegetarian/vegan/etc)
- Agent asks about food allergies
- Agent asks about food intolerances
- Agent asks about foods they dislike
- Agent asks about meal frequency preference
- Agent asks about wake time and workout time
- Agent validates and saves preferences via tool call
- System stores: diet_type, allergies, intolerances, dislikes, meal_frequency

#### Story 3.2: Generate Complete Meal Plan with Timing
**As a** new user  
**I want to** see a complete meal plan with timing generated for me  
**So that** I know exactly what and when to eat

**Acceptance Criteria:**
- Agent uses LLM to generate complete meal plan based on:
  - Goals (from Step 1)
  - Workout schedule (from Step 2)
  - Diet preferences (from Story 3.1)
  - Wake/sleep times
- Generated plan includes:
  - Daily calorie target (based on goal)
  - Macro split (protein/carbs/fats percentages)
  - Complete daily meal schedule with times
  - Specific meal suggestions for each time slot
  - Pre/post-workout nutrition
  - Weekly rotation/variety
  - Substitution options
- Plan respects all restrictions (allergies, dislikes)
- Meal timing aligns with workout schedule

#### Story 3.3: Review and Refine Meal Plan
**As a** new user  
**I want to** review and request changes to my meal plan  
**So that** I'm comfortable with what I'll be eating

**Acceptance Criteria:**
- User can read the complete generated meal plan
- User can request modifications ("Can we add more variety?", "Move dinner to 8 PM")
- Agent understands modification requests
- Agent regenerates plan with requested changes
- User can iterate until satisfied
- User explicitly approves the plan

#### Story 3.4: Save Approved Meal Plan
**As a** new user  
**I want to** have my approved meal plan saved  
**So that** I can access it after onboarding

**Acceptance Criteria:**
- Agent saves complete meal plan via tool call
- System creates MealPlanTemplate entity with full weekly_template JSONB
- System creates MealSchedule entities for each meal time
- System links plan to user's profile
- Agent confirms save and transitions to Step 4
- System marks step_3_complete = true

---

### Epic 4: Lifestyle Setup (Step 4)

#### Story 4.1: Set Up Hydration Reminders
**As a** new user  
**I want to** set up hydration tracking and reminders  
**So that** I stay properly hydrated

**Acceptance Criteria:**
- User chats with Scheduling Agent
- Agent asks about current water intake
- Agent recommends target based on activity level
- Agent asks about reminder preferences
- Agent validates and saves via tool call
- System stores: daily_water_target_ml, reminder_frequency_minutes, enable_reminders

#### Story 4.2: Set Up Supplement Preferences
**As a** new user  
**I want to** indicate my interest in supplement guidance  
**So that** I can get recommendations if interested

**Acceptance Criteria:**
- Agent asks if user is interested in supplement guidance
- Agent asks about current supplements (if any)
- Agent validates and saves via tool call
- System stores: interested_in_supplements, current_supplements
- Agent explains supplement guidance will be available in dashboard

#### Story 4.3: Complete Onboarding
**As a** new user  
**I want to** complete onboarding and access my dashboard  
**So that** I can start using the app

**Acceptance Criteria:**
- Agent confirms all steps are complete
- Agent calls complete_onboarding tool
- System creates UserProfile entity with is_locked=true
- System creates all related entities:
  - FitnessGoal records
  - PhysicalConstraint records
  - DietaryPreference record
  - MealPlan record
  - WorkoutPlan record
  - HydrationPreference record
- System creates initial UserProfileVersion snapshot
- System marks onboarding_state.is_complete = true
- System sets current_agent = "general_assistant"
- User is redirected to dashboard
- Dashboard shows:
  - Today's workout (if workout day)
  - Next meal and timing
  - Welcome message with next steps

---

### Epic 5: Agent Tool Implementation

#### Story 5.1: Fitness Assessment Agent Tools
**As a** Fitness Assessment Agent  
**I want to** save fitness assessment data  
**So that** other agents can use this information

**Acceptance Criteria:**
- Tool: `save_fitness_assessment(user_id, fitness_level, experience_years, primary_goal, secondary_goal, goal_priority)`
- Tool validates input data
- Tool saves to onboarding_state.agent_context["fitness_assessment"]
- Tool returns success confirmation
- Tool handles errors gracefully

#### Story 5.2: Workout Planning Agent Tools
**As a** Workout Planning Agent  
**I want to** save workout constraints and plans  
**So that** users have their workout plan stored

**Acceptance Criteria:**
- Tool: `save_workout_constraints(user_id, equipment, injuries, limitations, days_per_week, minutes_per_session)`
- Tool: `save_workout_plan(user_id, plan_data)`
- Tool: `generate_workout_plan(constraints, goals)` - LLM-powered
- Tools validate input data
- Tools save to database (WorkoutPlan table)
- Tools return success confirmation
- Tools handle errors gracefully

#### Story 5.3: Diet Planning Agent Tools
**As a** Diet Planning Agent  
**I want to** save diet preferences and meal plans  
**So that** users have their meal plan stored

**Acceptance Criteria:**
- Tool: `save_diet_preferences(user_id, diet_type, allergies, intolerances, dislikes, meal_frequency)`
- Tool: `save_meal_plan(user_id, plan_data)`
- Tool: `save_meal_schedules(user_id, schedules)`
- Tool: `generate_meal_plan(preferences, goals, timing)` - LLM-powered
- Tools validate input data
- Tools save to database (MealPlanTemplate, MealSchedule tables)
- Tools return success confirmation
- Tools handle errors gracefully

#### Story 5.4: Scheduling Agent Tools
**As a** Scheduling Agent  
**I want to** save hydration and supplement preferences  
**So that** users have their lifestyle preferences stored

**Acceptance Criteria:**
- Tool: `save_hydration_preferences(user_id, daily_water_target_ml, reminder_frequency_minutes, enable_reminders)`
- Tool: `save_supplement_preferences(user_id, interested, current_supplements)`
- Tool: `complete_onboarding(user_id)`
- Tools validate input data
- Tools save to database
- complete_onboarding creates UserProfile and all related entities
- Tools return success confirmation
- Tools handle errors gracefully

---

### Epic 6: Database Schema Changes

#### Story 6.1: Modify WorkoutPlan Table
**As a** developer  
**I want to** update the existing workout_plans table for new onboarding flow  
**So that** it supports the new plan structure

**Acceptance Criteria:**
- ‚úÖ workout_plans table ALREADY EXISTS with required fields:
  - id, user_id, plan_name, plan_description, duration_weeks, days_per_week
  - plan_data (JSONB) - perfect for storing complete plan structure
  - is_locked, locked_at
  - plan_rationale
- ‚úÖ Relationships to WorkoutDay and WorkoutExercise already exist
- ‚úÖ Unique constraint on user_id already exists
- NO CHANGES NEEDED - Current schema supports new flow
- Note: During onboarding, we'll populate plan_data JSONB with complete structure
- Note: WorkoutDay and WorkoutExercise can be populated later from plan_data if needed

#### Story 6.2: Add MealPlanTemplate JSONB Field
**As a** developer  
**I want to** add a weekly_template JSONB field to meal_templates table  
**So that** we can store complete meal plan structures

**Acceptance Criteria:**
- ‚úÖ meal_templates table ALREADY EXISTS with:
  - id, profile_id, week_number, is_active
  - Relationships to TemplateMeal
- ADD COLUMN weekly_template JSONB to meal_templates table
- ADD COLUMN plan_name VARCHAR(255) to meal_templates table
- ADD COLUMN daily_calorie_target INTEGER to meal_templates table
- ADD COLUMN protein_grams DECIMAL(6,2) to meal_templates table
- ADD COLUMN carbs_grams DECIMAL(6,2) to meal_templates table
- ADD COLUMN fats_grams DECIMAL(6,2) to meal_templates table
- Create Alembic migration for new columns
- Keep existing TemplateMeal relationships for backward compatibility

#### Story 6.3: Modify OnboardingState Table
**As a** developer  
**I want to** update onboarding state schema for 4-step flow  
**So that** the system tracks the new onboarding process

**Acceptance Criteria:**
- ‚úÖ onboarding_states table ALREADY EXISTS with:
  - user_id, current_step, is_complete
  - agent_context (JSONB) - perfect for storing agent data
  - conversation_history (JSONB) - perfect for chat history
  - agent_history (JSONB) - tracks agent routing
  - current_agent (VARCHAR)
- MODIFY current_step default from 0 to 1
- ADD COLUMN step_1_complete BOOLEAN DEFAULT FALSE
- ADD COLUMN step_2_complete BOOLEAN DEFAULT FALSE
- ADD COLUMN step_3_complete BOOLEAN DEFAULT FALSE
- ADD COLUMN step_4_complete BOOLEAN DEFAULT FALSE
- DROP COLUMN step_data (if exists - was for old 9-step system)
- Create Alembic migration
- Migration should clear existing onboarding_states (no backward compatibility needed)

#### Story 6.4: Update MealPlan Table
**As a** developer  
**I want to** ensure meal_plans table supports new flow  
**So that** nutritional targets are properly stored

**Acceptance Criteria:**
- ‚úÖ meal_plans table ALREADY EXISTS with:
  - profile_id, daily_calorie_target
  - protein_grams, carbs_grams, fats_grams (in grams, not percentages)
- NO CHANGES NEEDED - Current schema is perfect
- Note: We'll calculate grams from percentages during onboarding

#### Story 6.5: Verify Existing Preference Tables
**As a** developer  
**I want to** verify all preference tables support new flow  
**So that** no schema changes are missed

**Acceptance Criteria:**
- ‚úÖ Verify fitness_goals table exists (profile_id, goal_type, target_weight_kg, target_body_fat_percentage, priority)
- ‚úÖ Verify physical_constraints table exists (profile_id, constraint_type, description, severity)
- ‚úÖ Verify dietary_preferences table exists (profile_id, diet_type, allergies, intolerances, dislikes)
- ‚úÖ Verify meal_schedules table exists (profile_id, meal_name, scheduled_time, enable_notifications)
- ‚úÖ Verify workout_schedules table exists (profile_id, day_of_week, scheduled_time, enable_notifications)
- ‚úÖ Verify hydration_preferences table exists (profile_id, daily_water_target_ml, reminder_frequency_minutes, enable_notifications)
- ‚úÖ All tables support new onboarding flow
- NO CHANGES NEEDED

---

### Epic 7: API Endpoints

#### Story 7.1: Onboarding Chat Endpoint
**As a** frontend developer  
**I want to** send user messages to the onboarding agent  
**So that** users can have conversations during onboarding

**Acceptance Criteria:**
- Endpoint: `POST /api/v1/onboarding/chat`
- Request body: `{"message": "string", "step": int (optional)}`
- Response: `{"message": "string", "agent_type": "string", "current_step": int, "step_complete": bool, "next_action": "string"}`
- Endpoint authenticates user
- Endpoint loads current onboarding agent based on current_step
- Endpoint passes message to agent
- Agent processes message and returns response
- Conversation saved to conversation_history
- Returns 200 on success, 401 if unauthorized, 404 if state not found

#### Story 7.2: Get Current Step Endpoint
**As a** frontend developer  
**I want to** know the user's current onboarding step  
**So that** I can display the appropriate UI

**Acceptance Criteria:**
- Endpoint: `GET /api/v1/onboarding/current-step`
- Response: `{"current_step": int, "agent_type": "string", "step_1_complete": bool, "step_2_complete": bool, "step_3_complete": bool, "step_4_complete": bool}`
- Endpoint authenticates user
- Returns current onboarding state
- Returns 200 on success, 401 if unauthorized, 404 if state not found

#### Story 7.3: Generate Workout Plan Endpoint
**As a** frontend developer  
**I want to** trigger workout plan generation  
**So that** users can see their generated plan

**Acceptance Criteria:**
- Endpoint: `POST /api/v1/onboarding/generate-workout-plan`
- Request body: `{"constraints": {...}}` (optional, uses saved if not provided)
- Response: `{"plan": {...}}` (complete workout plan structure)
- Endpoint authenticates user
- Endpoint calls agent's generate_workout_plan tool
- Returns generated plan for preview
- Does NOT save to database (preview only)
- Returns 200 on success, 400 if constraints missing

#### Story 7.4: Save Workout Plan Endpoint
**As a** frontend developer  
**I want to** save the user's approved workout plan  
**So that** the plan is persisted and user advances to next step

**Acceptance Criteria:**
- Endpoint: `POST /api/v1/onboarding/save-workout-plan`
- Request body: `{"plan_data": {...}}`
- Response: `{"success": bool, "message": "string", "next_step": int}`
- Endpoint authenticates user
- Endpoint validates plan_data structure
- Endpoint saves to workout_plans table
- Endpoint marks step_2_complete = true
- Endpoint advances current_step to 3
- Returns 200 on success, 400 if validation fails

#### Story 7.5: Generate Meal Plan Endpoint
**As a** frontend developer  
**I want to** trigger meal plan generation  
**So that** users can see their generated meal plan

**Acceptance Criteria:**
- Endpoint: `POST /api/v1/onboarding/generate-meal-plan`
- Request body: `{"preferences": {...}}` (optional, uses saved if not provided)
- Response: `{"plan": {...}}` (complete meal plan structure)
- Endpoint authenticates user
- Endpoint calls agent's generate_meal_plan tool
- Returns generated plan for preview
- Does NOT save to database (preview only)
- Returns 200 on success, 400 if preferences missing

#### Story 7.6: Save Meal Plan Endpoint
**As a** frontend developer  
**I want to** save the user's approved meal plan  
**So that** the plan is persisted and user advances to next step

**Acceptance Criteria:**
- Endpoint: `POST /api/v1/onboarding/save-meal-plan`
- Request body: `{"plan_data": {...}}`
- Response: `{"success": bool, "message": "string", "next_step": int}`
- Endpoint authenticates user
- Endpoint validates plan_data structure
- Endpoint saves to meal_plan_templates table
- Endpoint creates meal_schedules records
- Endpoint marks step_3_complete = true
- Endpoint advances current_step to 4
- Returns 200 on success, 400 if validation fails

#### Story 7.7: Complete Onboarding Endpoint
**As a** frontend developer  
**I want to** complete the user's onboarding  
**So that** their profile is created and they can access the app

**Acceptance Criteria:**
- Endpoint: `POST /api/v1/onboarding/complete`
- Request body: None (uses saved data)
- Response: `{"profile_id": "uuid", "user_id": "uuid", "fitness_level": "string", "is_locked": bool, "onboarding_complete": bool, "message": "string"}`
- Endpoint authenticates user
- Endpoint verifies all 4 steps are complete
- Endpoint creates UserProfile with is_locked=true
- Endpoint creates all related entities (goals, constraints, preferences, etc.)
- Endpoint creates initial UserProfileVersion
- Endpoint marks is_complete = true
- Endpoint sets current_agent = "general_assistant"
- Returns 201 on success, 400 if steps incomplete, 409 if already complete

---

### Epic 8: Frontend Integration

#### Story 8.1: Onboarding Progress UI
**As a** user  
**I want to** see my progress through onboarding  
**So that** I know how much is left

**Acceptance Criteria:**
- Display progress indicator showing 4 steps
- Highlight current step
- Show checkmarks for completed steps
- Update in real-time as steps complete

#### Story 8.2: Chat Interface
**As a** user  
**I want to** chat naturally with the onboarding agent  
**So that** onboarding feels conversational

**Acceptance Criteria:**
- Display chat messages in conversation format
- Show user messages on right, agent messages on left
- Show typing indicator when agent is responding
- Auto-scroll to latest message
- Allow text input and send button
- Handle enter key to send message

#### Story 8.3: Workout Plan Preview
**As a** user  
**I want to** see my generated workout plan in a readable format  
**So that** I can review it before approving

**Acceptance Criteria:**
- Display workout plan with clear formatting
- Show each day with exercises, sets, reps
- Show progressive overload strategy
- Show rest days
- Allow scrolling through full plan
- Show "Request Changes" and "Approve Plan" buttons

#### Story 8.4: Meal Plan Preview
**As a** user  
**I want to** see my generated meal plan in a readable format  
**So that** I can review it before approving

**Acceptance Criteria:**
- Display meal plan with clear formatting
- Show daily schedule with meal times
- Show meal options for each time slot
- Show macros and calories
- Show weekly rotation
- Allow scrolling through full plan
- Show "Request Changes" and "Approve Plan" buttons

#### Story 8.5: Onboarding Completion Screen
**As a** user  
**I want to** see a completion screen after finishing onboarding  
**So that** I know I'm ready to start

**Acceptance Criteria:**
- Display success message
- Show summary of created plans
- Show "View My Workout Plan" button
- Show "View My Meal Plan" button
- Show "Go to Dashboard" button
- Auto-redirect to dashboard after 5 seconds

---

## Non-Functional Requirements

### Performance
- Chat response time: <2 seconds for simple messages
- Plan generation time: <10 seconds for workout plans
- Plan generation time: <15 seconds for meal plans
- Database save operations: <500ms
- API endpoint response time: <1 second (excluding LLM calls)

### Scalability
- Support 1000+ concurrent onboarding sessions
- Handle 10,000+ plan generations per day
- Database queries optimized with proper indexes

### Security
- All endpoints require JWT authentication
- Validate all user inputs
- Sanitize LLM outputs before saving
- Prevent SQL injection in JSONB queries
- Rate limit plan generation (max 5 per minute per user)

### Reliability
- LLM fallback if primary model fails
- Graceful error handling in agent tools
- Transaction rollback on save failures
- Conversation history preserved on errors

### Usability
- Mobile-responsive chat interface
- Clear error messages
- Progress saved automatically
- Can resume onboarding if interrupted

---

## Technical Constraints

### Technology Stack
- Backend: FastAPI (Python 3.11+)
- Database: PostgreSQL 15+ with JSONB support
- LLM: Anthropic Claude (primary), OpenAI (fallback)
- Agent Framework: Custom agent orchestration
- Frontend: React/Next.js (separate spec)

### Dependencies
- Existing user authentication system
- Existing agent framework
- Existing database models (User, UserProfile)

### Data Retention
- Conversation history: Retained indefinitely
- Agent context: Retained until onboarding complete
- Generated plans: Retained as UserProfileVersion snapshots

---

## Out of Scope

The following are explicitly NOT included in this feature:

1. **Editing Plans Post-Onboarding** - Users can request changes through general chat, but dedicated edit UI is separate feature
2. **Exercise Video Library** - Video URLs referenced but library management is separate
3. **Meal Recipe Database** - Meal suggestions provided but full recipe system is separate
4. **Progress Tracking** - Workout/meal logging is separate feature
5. **Notification System** - Reminder scheduling is separate feature
6. **Payment/Subscription** - Onboarding is free, monetization is separate
7. **Social Features** - Sharing plans with friends is separate
8. **Wearable Integration** - Fitness tracker sync is separate

---

## Risks & Mitigations

### Risk 1: LLM Plan Generation Quality
**Risk:** Generated plans may not meet quality standards  
**Impact:** High - Users may reject plans or lose trust  
**Mitigation:**
- Extensive prompt engineering and testing
- Human review of sample plans before launch
- Feedback loop to improve prompts
- Fallback to template-based plans if LLM fails

### Risk 2: Plan Generation Latency
**Risk:** LLM calls may take too long (>15 seconds)  
**Impact:** Medium - Users may abandon during generation  
**Mitigation:**
- Show loading indicator with progress messages
- Optimize prompts for faster generation
- Cache common plan patterns
- Set timeout and fallback to simpler plans

### Risk 3: User Confusion During Chat
**Risk:** Users may not understand what agent is asking  
**Impact:** Medium - May provide incorrect information  
**Mitigation:**
- Clear agent prompts with examples
- Agent can ask clarifying questions
- Allow users to go back and correct information
- Provide help text and tooltips

### Risk 4: Database Migration Complexity
**Risk:** Migrating from 9-step to 4-step may cause data loss  
**Impact:** Low - No backward compatibility required  
**Mitigation:**
- Clear communication to users about re-onboarding
- Export old data before migration
- Test migration thoroughly in staging

### Risk 5: Agent Tool Failures
**Risk:** Tool calls may fail due to validation or database errors  
**Impact:** High - Onboarding cannot complete  
**Mitigation:**
- Comprehensive error handling in tools
- Retry logic for transient failures
- Clear error messages to users
- Manual intervention capability for support team

---

## Dependencies

### Upstream Dependencies
- User authentication system must be functional
- Database must be accessible
- LLM API keys must be valid and have quota
- Agent framework must be operational

### Downstream Dependencies
- Frontend onboarding UI (separate spec)
- General assistant agent (receives users after onboarding)
- Dashboard UI (displays plans after onboarding)
- Notification system (uses saved schedules)

---

## Testing Requirements

### Unit Tests
- All agent tool functions
- All validation logic
- All database operations
- All API endpoints

### Integration Tests
- Complete onboarding flow (all 4 steps)
- Agent orchestration and handoffs
- Database transactions and rollbacks
- API endpoint chains

### Property-Based Tests
- Plan generation produces valid structures
- Saved data matches input data
- All constraints are respected in generated plans
- Macro percentages always sum to 100%

### Manual Testing
- User experience testing with real users
- Plan quality review by fitness experts
- Conversation flow testing
- Edge case testing (unusual inputs)

### Performance Tests
- Load testing with 1000 concurrent users
- Plan generation latency testing
- Database query performance testing

---

## Acceptance Criteria Summary

This feature is considered complete when:

1. ‚úÖ All 4 onboarding steps are functional
2. ‚úÖ Users can chat naturally with agents
3. ‚úÖ Workout plans are generated and can be approved
4. ‚úÖ Meal plans are generated and can be approved
5. ‚úÖ All data is saved correctly via agent tools
6. ‚úÖ UserProfile is created on completion
7. ‚úÖ All API endpoints are functional
8. ‚úÖ All database migrations are applied
9. ‚úÖ All tests pass (unit, integration, property-based)
10. ‚úÖ Onboarding completion rate >85%
11. ‚úÖ Average completion time <25 minutes
12. ‚úÖ User satisfaction >4.5/5

---

## Glossary

- **Agent Tool:** A function that agents can call to interact with the database or external systems
- **Plan Generation:** LLM-powered creation of workout or meal plans based on user inputs
- **Plan Refinement:** Iterative process where user requests changes and agent regenerates plan
- **JSONB:** PostgreSQL data type for storing JSON with indexing and querying capabilities
- **Progressive Overload:** Fitness principle of gradually increasing workout difficulty
- **Macro Split:** Distribution of calories across protein, carbohydrates, and fats

---

## References

- [New Onboarding Flow Documentation](../../docs/technichal/New_Onboarding_Flow.md)
- [Original Onboarding Specification](../../docs/technichal/Onboarding.md)
- [Database Schema Documentation](../../docs/technichal/backend_schema.md)
- [Agent Architecture Documentation](../../docs/technichal/backend_trd.md)

---

## Approval

**Requirements Approved By:** Product Team  
**Date:** 2026-02-20  
**Next Step:** Design Document Creation



---

## 8. API and Agent Analysis

### 8.1 Current System Analysis

**Analysis Complete**: See `docs/technichal/Current_API_and_Agent_Analysis.md`

**Key Findings**:
- ‚úÖ WorkoutPlanGenerator service is perfect - generates complete plans, supports modifications
- ‚úÖ MealPlanGenerator service is perfect - generates complete plans with macros and sample meals
- ‚úÖ Agent tools are well-designed - save to agent_context JSONB field
- ‚úÖ Base agent architecture is solid - uses LangChain with structured tool-calling
- ‚úÖ API endpoints are well-structured - most can be reused with minor modifications

### 8.2 Current vs New Agent Mapping

**Current System** (9 steps, 5 agents):
```
Steps 1-2: FitnessAssessmentAgent
Step 3:    GoalSettingAgent
Steps 4-5: DietPlanningAgent
Steps 6-7: WorkoutPlanningAgent
Steps 8-9: SchedulingAgent
```

**New System** (4 steps, 4 agents):
```
Step 1: FitnessAssessmentAgent (enhanced - adds goal collection)
Step 2: WorkoutPlanningAgent (enhanced - adds constraint collection + plan approval)
Step 3: DietPlanningAgent (enhanced - adds plan approval)
Step 4: SchedulingAgent (simplified - removes workout/meal schedules, adds supplements)
```

### 8.3 API Endpoint Changes

**File**: `backend/app/api/v1/endpoints/onboarding.py`

| Endpoint | Method | Status | Changes Needed |
|----------|--------|--------|----------------|
| `/onboarding/progress` | GET | ‚úÖ Keep | Update for 4 steps instead of 9 |
| `/onboarding/state` | GET | ‚úÖ Keep | Update for 4 steps |
| `/onboarding/chat` | POST | ‚úÖ Keep | Update orchestrator mapping |
| `/onboarding/current-agent` | GET | ‚úÖ Keep | Update agent descriptions |
| `/onboarding/complete` | POST | ‚úÖ Keep | No changes needed! |
| `/onboarding/step` | POST | ‚ùå Remove | Redundant - agents save via tools |

### 8.4 Agent Changes Required

#### FitnessAssessmentAgent (Step 1)
**File**: `backend/app/agents/onboarding/fitness_assessment.py`

**Current Responsibility**: Assess fitness level (steps 1-2)

**New Responsibility**: Assess fitness level + collect fitness goals (step 1)

**Changes**:
- ‚úèÔ∏è Merge goal-setting functionality from GoalSettingAgent
- ‚úèÔ∏è Update prompt to collect both fitness level AND goals in one conversation
- ‚úèÔ∏è Add tool to save goals (or extend existing save_fitness_assessment tool)

**Tools**:
- ‚úÖ Keep: `save_fitness_assessment` (extend to include goals)

---

#### WorkoutPlanningAgent (Step 2)
**File**: `backend/app/agents/onboarding/workout_planning.py`

**Current Responsibility**: Generate workout plan (steps 6-7)

**New Responsibility**: Collect constraints + generate complete workout plan + get approval (step 2)

**Changes**:
- ‚úèÔ∏è Merge constraint collection from GoalSettingAgent
- ‚úèÔ∏è Update prompt to:
  1. Ask about constraints (equipment, location, injuries)
  2. Generate COMPLETE workout plan using WorkoutPlanGenerator
  3. Present plan to user with full details
  4. Handle approval/modification requests
  5. Collect workout schedule (days and times)
  6. Save approved plan + schedule via tool calls

**Tools**:
- ‚úÖ Keep: `generate_workout_plan` (uses WorkoutPlanGenerator service)
- ‚úÖ Keep: `save_workout_plan` (saves to agent_context)
- ‚úÖ Keep: `modify_workout_plan` (modifies existing plan)
- ‚úÖ Add: `save_workout_schedule` (move from SchedulingAgent)

**Service Used**: `WorkoutPlanGenerator` - ‚úÖ No changes needed!

---

#### DietPlanningAgent (Step 3)
**File**: `backend/app/agents/onboarding/diet_planning.py`

**Current Responsibility**: Generate meal plan (steps 4-5)

**New Responsibility**: Collect preferences + generate complete meal plan + get approval (step 3)

**Changes**:
- ‚úèÔ∏è Update prompt to:
  1. Ask about diet preferences, allergies, dislikes, meal frequency
  2. Generate COMPLETE meal plan using MealPlanGenerator
  3. Present plan with sample meals, macros, and timing suggestions
  4. Handle approval/modification requests
  5. Collect meal schedule (meal times)
  6. Save approved plan + schedule via tool calls

**Tools**:
- ‚úÖ Keep: `generate_meal_plan` (uses MealPlanGenerator service)
- ‚úÖ Keep: `save_meal_plan` (saves to agent_context)
- ‚úÖ Keep: `modify_meal_plan` (modifies existing plan)
- ‚úÖ Add: `save_meal_schedule` (move from SchedulingAgent)

**Service Used**: `MealPlanGenerator` - ‚úÖ No changes needed!

---

#### SchedulingAgent (Step 4)
**File**: `backend/app/agents/onboarding/scheduling.py`

**Current Responsibility**: Collect workout, meal, and hydration schedules (steps 8-9)

**New Responsibility**: Collect hydration preferences + provide supplement guidance (step 4)

**Changes**:
- ‚ùå Remove: Workout schedule collection (moved to WorkoutPlanningAgent)
- ‚ùå Remove: Meal schedule collection (moved to DietPlanningAgent)
- ‚úÖ Keep: Hydration preferences collection
- ‚úèÔ∏è Add: Supplement guidance (informational only, no prescription)
- ‚úèÔ∏è Update prompt accordingly

**Tools**:
- ‚ùå Remove: `save_workout_schedule` (move to WorkoutPlanningAgent)
- ‚ùå Remove: `save_meal_schedule` (move to DietPlanningAgent)
- ‚úÖ Keep: `save_hydration_preferences`

---

#### GoalSettingAgent
**File**: `backend/app/agents/onboarding/goal_setting.py`

**Status**: ‚ùå **REMOVE**
- Merge fitness goals into FitnessAssessmentAgent (step 1)
- Merge workout constraints into WorkoutPlanningAgent (step 2)

---

### 8.5 Agent Orchestrator Changes

**File**: `backend/app/services/onboarding_orchestrator.py`

**Changes Required**:

1. Update `_step_to_agent()` method:
```python
def _step_to_agent(self, step: int) -> OnboardingAgentType:
    if step < 1 or step > 4:  # Changed from 9 to 4
        raise ValueError(f"Invalid onboarding step: {step}")
    
    if step == 1:
        return OnboardingAgentType.FITNESS_ASSESSMENT
    elif step == 2:
        return OnboardingAgentType.WORKOUT_PLANNING
    elif step == 3:
        return OnboardingAgentType.DIET_PLANNING
    else:  # step 4
        return OnboardingAgentType.SCHEDULING
```

2. Remove GoalSettingAgent from `agent_classes` dict in `_create_agent()` method

3. Update agent descriptions in `/onboarding/current-agent` endpoint

---

### 8.6 Service Layer Status

#### WorkoutPlanGenerator
**File**: `backend/app/services/workout_plan_generator.py`

**Status**: ‚úÖ **KEEP AS-IS - PERFECT FOR NEW FLOW**

**Key Methods**:
- `generate_plan()` - Generates complete workout plan with exercises, sets, reps, rest periods
- `modify_plan()` - Modifies existing plan based on user feedback

**Generates**:
- Complete workout split (Full Body, Upper/Lower, PPL, Body Part Split)
- Detailed exercises with sets, reps, rest periods, notes
- Progression strategy
- Duration estimates

**No changes needed!**

---

#### MealPlanGenerator
**File**: `backend/app/services/meal_plan_generator.py`

**Status**: ‚úÖ **KEEP AS-IS - PERFECT FOR NEW FLOW**

**Key Methods**:
- `generate_plan()` - Generates complete meal plan with macros and sample meals
- `modify_plan()` - Modifies existing plan based on user feedback

**Generates**:
- Daily calorie target
- Macro breakdown (protein, carbs, fats in grams)
- Sample meals with ingredients and nutrition info
- Meal timing suggestions

**No changes needed!**

---

### 8.7 Complexity Assessment

**Overall Complexity**: MEDIUM-LOW

**Why it's easier than expected**:
1. ‚úÖ Services (WorkoutPlanGenerator, MealPlanGenerator) are already perfect
2. ‚úÖ Agent tools are already perfect
3. ‚úÖ Base agent architecture is solid
4. ‚úÖ API endpoint structure is good
5. ‚úÖ Database schema needs minimal changes (see section 7)

**What actually needs work**:
1. ‚úèÔ∏è Update agent prompts (4 agents)
2. ‚úèÔ∏è Update orchestrator mapping (1 method)
3. ‚úèÔ∏è Merge/remove GoalSettingAgent
4. ‚úèÔ∏è Update API endpoint metadata
5. ‚úèÔ∏è Database migration (minimal - see section 7)

**Estimated Effort**:
- Agent prompt updates: 2-3 days
- Orchestrator changes: 1 day
- API updates: 1 day
- Database migration: 1 day
- Testing: 2-3 days
- **Total: 7-9 days**

---

### 8.8 Risk Assessment

**Low Risk**:
- ‚úÖ Services are stable and tested
- ‚úÖ Tool implementations are solid
- ‚úÖ Base architecture is sound
- ‚úÖ Most infrastructure already exists

**Medium Risk**:
- ‚ö†Ô∏è Agent prompt engineering (need to test approval workflow)
- ‚ö†Ô∏è Conversation flow (ensure natural transitions)
- ‚ö†Ô∏è User experience (plan presentation and modification)

**Mitigation**:
- Use existing agent patterns as templates
- Test each agent independently before integration
- Implement feature flags for gradual rollout
- A/B test old vs new flow with small user group first
- Monitor completion rates and user feedback closely

---

### 8.9 Implementation Priority

**Phase 1: Foundation** (Days 1-2)
1. Update database schema (add columns, migration)
2. Update orchestrator mapping
3. Remove GoalSettingAgent

**Phase 2: Agent Updates** (Days 3-5)
1. Update FitnessAssessmentAgent (step 1)
2. Update WorkoutPlanningAgent (step 2)
3. Update DietPlanningAgent (step 3)
4. Update SchedulingAgent (step 4)

**Phase 3: API & Integration** (Days 6-7)
1. Update API endpoints
2. Update response schemas
3. Integration testing

**Phase 4: Testing & Refinement** (Days 8-9)
1. End-to-end testing
2. Prompt refinement
3. User acceptance testing

---

### 8.10 Success Metrics

**Technical Metrics**:
- All tests pass (unit, integration, e2e)
- API response times < 200ms
- Agent response times < 3s
- Zero data loss during migration

**User Metrics**:
- Onboarding completion rate > 85%
- Average completion time < 25 minutes
- User satisfaction score > 4.2/5
- Plan modification rate < 30% (indicates good initial plans)

---

## 9. Technology Stack

- **Backend**: FastAPI (Python 3.11+) with Poetry for dependency management
- **Database**: PostgreSQL 15+ with JSONB support
- **AI/LLM**: Anthropic Claude via LangChain
- **Agent Framework**: LangChain with structured tool-calling
- **Real-time**: LiveKit for voice/text sessions
- **Services**: WorkoutPlanGenerator, MealPlanGenerator (already implemented)
- **Testing**: pytest with async support, hypothesis for property-based testing

---

## 10. Development Approach

- **Iterative Development**: Implement and test each agent independently
- **Feature Flags**: Gradual rollout with ability to rollback
- **A/B Testing**: Compare old vs new flow performance
- **Code Reuse**: Leverage existing services and tools (minimal new code)
- **Poetry Commands**: Use `poetry run` for all Python commands
- **Testing**: Comprehensive unit and integration tests for each agent
- **Documentation**: Update technical docs as implementation progresses

